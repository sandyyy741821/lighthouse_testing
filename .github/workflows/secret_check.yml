name: Check .env Variables in PR

on:
  push:
    branches:
      - '**'
  pull_request_target:
  workflow_dispatch:

jobs:
  check-env:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find all .env files in PR branch
        run: |
            ENV_FILES=$(find . -type f -name ".env*" | tr '\n' ':' || true)
            echo "ENV_FILES=$ENV_FILES" >> $GITHUB_ENV
            echo "Found .env files: $ENV_FILES"

      - name: Extract variable names with values
        run: |
            > env-vars-report.txt
            ENV_FILES=$(find . -type f -name ".env*" | tr '\n' ':' || true)

            if [ -n "$ENV_FILES" ]; then
            for file in ${ENV_FILES//:/ }; do
                if [ -f "$file" ]; then
                # Extract variables with non-empty, non-whitespace values
                grep -E "^[A-Za-z_][A-Za-z0-9_]*=[^[:space:]]+" "$file" | cut -d '=' -f 1 >> env-vars-report.txt
                fi
            done
            fi

            if [ -s env-vars-report.txt ]; then
            echo "❌ Variables with values detected in .env files:"
            cat env-vars-report.txt
            exit 1
            else
            echo "✅ No .env variables with values detected. PR is clean."
            fi

      - name: Fail PR if any .env variables have values
        run: |
            if [ -s env-vars-report.txt ]; then
            echo "ERROR: Some .env variables have values! Only variable names are allowed in PR."
            exit 1
            fi
